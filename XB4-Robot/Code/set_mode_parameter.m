
%XB4
mode=0;
%XB7
%mode=1;
if (0==mode)
    d1=0.342;a1=0.040;a2=0.275;a3=0.025;d4=0.280;dt=0.073;d3=0;
end
if (1==mode)
    d1=0.380;a1=0.030;a2=0.340;a3=0.035;d4=0.345;dt=0.087;d3=0;
end


m1=0.167;  m2=1;  m3=0.5;  m4=0.333;  m5=0.25;  m6=0.2;

mc11=0;  mc12=0;  mc13=0.2;
mc21=0.1291;  mc22=0;  mc23=3.3117;
mc31=1.6484;  mc32=0;  mc33=0.8748;
mc41=0.3200;  mc42=0.2324;  mc43=0.7083;
mc51=0.4574;  mc52=0;  mc53=0.6427;
mc61=0.3200;  mc62=-0.0513;  mc63=0.6417;%质心位置

Ic111=0;  Ic122=0;  Ic133=1.3676;  Ic112=0;  Ic113=0;  Ic123=0;
Ic211=8.8194;  Ic222=6.0549;  Ic233=0.9569;  Ic212=0;  Ic213=0;  Ic223=0;
Ic311=0.0332;  Ic322=1.8442;  Ic333=1.0560;  Ic312=0;  Ic313=0;  Ic323=0;
Ic411=0.1448;  Ic422=0.0015;  Ic433=0.0822;  Ic412=0;  Ic413=0;  Ic423=0;
Ic511=0;  Ic522=0.0121;  Ic533=0.0299;  Ic512=0;  Ic513=0;  Ic523=0;
Ic611=0.0134;  Ic622=0;  Ic633=0.0051;  Ic612=0;  Ic613=0;  Ic623=0;%惯性矩

g=9.80200;

Ia1=0; Ia2=0; Ia3=0; Ia4=0; Ia5=0; Ia6=0;%关节惯性
fv1=0; fc1=0; fv2=0; fc2=0; fv3=0; fc3=0; 
fv4=0; fc4=0; fv5=0; fc5=0; fv6=0; fc6=0;%粘滞摩擦,库伦摩擦


% D_H = [
%     40,     pi/2,     342,      0;
%     275,    0,        0,        0;
%     25,     pi/2,     0,        0;
%     0,     -pi/2,     280,      0;
%     0,      pi/2,     0,        0;
%     0,      0,        73,       0
% ];

% MDH = [
%     0.040,   -pi/2,   0.342,   0;   % Joint 1
%     0.275,    0,      0.000,   0;   % Joint 2
%     0.025,   -pi/2,   0.000,   0;   % Joint 3
%     0.000,    pi/2,   0.280,   0;   % Joint 4
%     0.000,   -pi/2,   0.000,   0;   % Joint 5
%     0.000,    0,      0.073,   0    % Joint 6 (tool length)
% ];

MDH = [
    0,       0,        0.342,   0;
    0.040,  -pi/2,     0,      -pi/2;
    0.275,   0,        0,       0;
    0.025,  -pi/2,     0.280,   0;
    0,       pi/2,     0,       0;
    0,      -pi/2,     0.073,   0;
];


R1 = [0 0 1;
     0 -1 0;
     1  0 0];

R2 = [1 0 0;
     0 1 0;
     0  0 1];

deg2rad = pi/180;  % 角度转弧度系数

joint_limits_deg = [
    -170,  170;    % 关节1
    -90,   90;     % 关节2  
    -120,  120;    % 关节3
    -180,  180;    % 关节4
    -120,  120;    % 关节5
    -180,  180     % 关节6
];

joint_limits = joint_limits_deg;

% SDH = [
%     0       -pi/2    0.342    0;
%     0.275    0       0        0;
%     0.025    0       0        0;
%     0       -pi/2    0.280    0;
%     0        pi/2    0        0;
%     0        0       0.073    0];



[XB4_DOF6, ArmInfo] = importrobot('XB4Robot');

% 加载机器人后，立即设置数据格式
% XB4_DOF6.DataFormat = 'column';

wp = [0.393 0 0.64; 0.275 0 0.53; 0.475 0 0.53; 0.475 0 0.33; 0.275 0 0.33; 0.275 0 0.53; 0.393 0 0.64]';

wp_1 = [0.393 0 0.64; 0.275 0 0.53; 0.475 0 0.53; 0.475 0 0.33; 0.275 0 0.33; 0.275 0 0.53; 0.393 0 0.64]';  

wp_t = linspace(0, 7, size(wp,2));

wp_2 = [0.393 0 0.64 0 0 0; 0.275 0 0.53 0 0 0; 0.475 0 0.53 0 0 0; 0.475 0 0.33 0 0 0; 0.275 0 0.33 0 0 0; 0.275 0 0.53 0 0 0; 0.393 0 0.64 0 0 0]';

wp_new = [
0.466  0.000  0.454;
0.416  0.043  0.498;
0.316 -0.043  0.498;
0.266  0.000  0.454;
0.316  0.043  0.411;
0.416 -0.043  0.411;
0.466  0.000  0.454;
]';

% q_waypoints = zeros(6, size(wp,2));
% 
% % 创建 IK 解算器
% ik = inverseKinematics('RigidBodyTree', XB4_DOF6); % 确保这里是用你的机器人对象

% weights = [0 0 0 1 1 1];
% initialGuess = zeros(6,1); % 初始猜测
% q_waypoints = zeros(6, size(wp,2)); % 存储关节角度
% 
% disp('正在预计算关节角度...');
% for i = 1:size(wp,2)
%     % 构造目标位姿 (这里只取了位置，姿态假设为朝下，你可以根据需要修改)
%     % 注意：原本你的 TrVec 只有位置，这里我补充一个固定的旋转矩阵
%     % 假设末端执行器垂直向下 (根据你的DH参数可能需要调整)
%     tform = trvec2tform(wp(:,i)') * axang2tform([0 1 0 pi]); 
% 
%     [sol, info] = ik('Body6', tform, weights, initialGuess); % 确保 'Body6' 是你末端的名字
%     q_waypoints(:,i) = sol;
%     initialGuess = sol; % 用上一次的解作为下一次的猜测，保证连续性
% end

